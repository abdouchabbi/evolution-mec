document.addEventListener("DOMContentLoaded",()=>{let e=!1,t=null,a=null,n=[],i=null,l=null,r=[],s=0,o=null,d=null,c=document.getElementById("loading-overlay"),p=document.getElementById("login-view"),m=document.getElementById("main-app-view"),u=document.getElementById("login-form"),g=document.getElementById("email-input"),$=document.getElementById("password-input"),y=document.getElementById("logout-btn"),b=document.querySelectorAll(".sidebar-link"),v=document.querySelectorAll("main section"),h=document.getElementById("alert-modal"),f=document.getElementById("alert-modal-content"),E=document.getElementById("face-modal"),I=document.getElementById("face-modal-title"),L=document.getElementById("video"),w=document.getElementById("status-message"),x=document.getElementById("action-face-btn"),_=document.getElementById("cancel-face-btn"),B=document.getElementById("pin-modal"),T=document.getElementById("save-pin-btn"),k=document.getElementById("cancel-pin-btn"),S=document.getElementById("edit-user-modal"),M=document.getElementById("edit-user-form"),H=document.getElementById("cancel-edit-user-btn"),D=document.getElementById("notification-bell-btn"),C=document.getElementById("notification-badge"),j=document.getElementById("notification-panel"),F=document.getElementById("notification-list"),N=document.getElementById("main-header-title"),z={async request(e,t="GET",a=null){let n=localStorage.getItem("authToken"),i={"Content-Type":"application/json"};n&&(i.Authorization=`Bearer ${n}`);try{let l=await fetch(`http://localhost:5000/api/${e}`,{method:t,headers:i,body:a?JSON.stringify(a):null});if(204===l.status)return null;let r=await l.text();if(!l.ok){401===l.status&&A();let s=`Errore del server (${l.status})`;try{let o=JSON.parse(r);o.message&&(s=o.message)}catch(d){}throw Error(s)}try{return JSON.parse(r)}catch(c){throw console.error("Risposta non JSON dal server:",r),Error("Il server ha restituito una risposta in un formato non valido.")}}catch(p){throw"POST"===t&&"users/login"===e||(p.message.includes("Failed to fetch")?W("Connessione al server non riuscita. Assicurarsi che il server sia in esecuzione."):W(`Si \xe8 verificato un errore: ${p.message}`)),console.error(`${t} ${e} failed:`,p),p}},get(e){return this.request(e)},post(e,t){return this.request(e,"POST",t)},put(e,t){return this.request(e,"PUT",t)},delete(e){return this.request(e,"DELETE")}};async function O(e){e.preventDefault();let t=g.value,a=$.value,n=document.getElementById("login-btn"),i=n.innerHTML;n.disabled=!0,n.innerHTML='<div class="w-5 h-5 border-2 border-white border-t-transparent rounded-full animate-spin"></div>';try{let l=await z.post("users/login",{email:t,password:a});localStorage.setItem("authToken",l.token),U()}catch(r){console.error("Tentativo di login fallito.");let s=document.querySelector(".glass-panel");n.classList.remove("bg-indigo-600","hover:bg-indigo-700"),n.classList.add("bg-red-600"),n.innerHTML="<span>CREDENZIALI ERRATE</span>",s.classList.add("animate-shake"),setTimeout(()=>{n.disabled=!1,n.innerHTML=i,n.classList.add("bg-indigo-600","hover:bg-indigo-700"),n.classList.remove("bg-red-600"),s.classList.remove("animate-shake")},2e3)}}function A(){localStorage.removeItem("authToken"),d&&clearInterval(d),R()}async function P(){c.classList.remove("hidden");let e=localStorage.getItem("authToken");if(e)try{await z.get("users/profile"),await U()}catch(t){A()}else R()}function R(){document.body.classList.add("login-body"),p.classList.add("flex"),m.classList.add("hidden"),c.classList.add("hidden")}async function U(){document.body.classList.remove("login-body"),p.classList.remove("flex"),p.classList.add("hidden"),m.classList.remove("hidden"),q({preventDefault(){},currentTarget:document.querySelector('[data-section="dashboard-section"]')}),V(),es()}function q(e){e.preventDefault();let t=e.currentTarget.dataset.section,a=e.currentTarget.querySelector("span").textContent;N.textContent=a,b.forEach(e=>e.classList.remove("active")),e.currentTarget.classList.add("active"),v.forEach(e=>{e.classList.toggle("hidden",e.id!==t)}),"dashboard-section"===t&&en(),"employees-section"===t&&eg(),"clients-section"===t&&eU(),"reports-section"===t&&eM(),"users-section"===t&&ef(),"settings-section"===t&&(eC(),eN(),eF(),eq())}function W(e,t=!1){f.innerHTML=`<p class="${t?"text-green-600":"text-red-600"}">${e}</p><div class="mt-4 flex justify-end"><button id="modal-ok-btn" class="bg-blue-600 text-white px-4 py-2 rounded-md">OK</button></div>`,document.getElementById("modal-ok-btn").onclick=G,h.classList.remove("hidden"),h.classList.add("flex"),setTimeout(()=>f.classList.remove("scale-95","opacity-0"),10)}function G(){f.classList.add("scale-95","opacity-0"),setTimeout(()=>{h.classList.add("hidden"),h.classList.remove("flex")},300)}async function V(){if(!e)try{let t="https://justadudewhohacks.github.io/face-api.js/models";await Promise.all([faceapi.nets.tinyFaceDetector.loadFromUri(t),faceapi.nets.faceLandmark68Net.loadFromUri(t),faceapi.nets.faceRecognitionNet.loadFromUri(t)]),e=!0,console.log("Modelli Face API caricati con successo.")}catch(a){console.error("Errore durante il caricamento dei modelli face-api:",a)}}function Y(t,a){if(!e)return W("I modelli di riconoscimento facciale non sono ancora stati caricati. attendere prego.");I.textContent=`Registra impronta per: ${t}`,x.dataset.employeeId=a,E.classList.remove("hidden"),E.classList.add("flex"),J()}function Z(){K(),E.classList.add("hidden"),E.classList.remove("flex")}async function J(){try{t=await navigator.mediaDevices.getUserMedia({video:{}}),L.srcObject=t,L.addEventListener("play",Q)}catch(e){W("Impossibile accedere alla fotocamera. Si prega di concedere l'autorizzazione."),Z()}}function K(){a&&clearInterval(a),t&&t.getTracks().forEach(e=>e.stop()),L.srcObject=null,w.textContent="Punta il viso verso la fotocamera...",x.disabled=!0}function Q(){a=setInterval(async()=>{let e=await faceapi.detectSingleFace(L,new faceapi.TinyFaceDetectorOptions);e?(w.textContent="Viso rilevato. Pronto per registrare.",x.disabled=!1):(w.textContent="Punta un solo viso verso la fotocamera.",x.disabled=!0)},500)}async function X(){w.textContent="Elaborazione immagine...",x.disabled=!0;let e=await faceapi.detectSingleFace(L,new faceapi.TinyFaceDetectorOptions).withFaceLandmarks().withFaceDescriptor();if(!e){W("Impossibile rilevare chiaramente il viso. Riprova."),K(),J();return}let t=x.dataset.employeeId,a=Array.from(e.descriptor);try{await z.post("employees/face",{employeeId:t,descriptor:a}),W("Impronta facciale registrata con successo!",!0),Z(),eg()}catch(n){K(),J()}}function ee(e,t){document.getElementById("pin-employee-name").textContent=`Per il dipendente: ${t}`,T.dataset.employeeId=e,B.classList.remove("hidden"),B.classList.add("flex")}function et(){document.getElementById("pin-input").value="",B.classList.add("hidden"),B.classList.remove("flex")}async function ea(){let e=document.getElementById("pin-input").value;if(!/^\d{4}$/.test(e))return W("Il PIN deve essere di 4 cifre.");let t=T.dataset.employeeId;try{await z.put(`employees/${t}/set-pin`,{pin:e}),W("Codice PIN impostato con successo!",!0),et()}catch(a){}}async function en(){c.classList.remove("hidden"),i&&i.destroy(),l&&l.destroy();try{let[e,t,a,n]=await Promise.all([z.get("employees"),z.get("clients"),z.get("projects"),z.get("timesheets")]),r=new Date,s=r.getFullYear(),o=r.getMonth(),d=n.filter(e=>{let t=new Date(e.date);return t.getFullYear()===s&&t.getMonth()===o});document.getElementById("total-employees").textContent=e.length,document.getElementById("total-clients").textContent=t.length,document.getElementById("total-projects").textContent=a.length;let p={},m={},u=0;e.forEach(e=>{p[e.name]=0}),a.forEach(e=>{m[e.name]=0}),d.forEach(e=>{u+=e.totalHours||0,void 0!==p[e.employeeName]&&(p[e.employeeName]+=e.totalHours||0)}),d.forEach(e=>{let t=[...new Set(e.entries.map(e=>e.project).filter(Boolean))];if(t.length>0){let a=(e.totalHours||0)/t.length;t.forEach(e=>{void 0!==m[e]&&(m[e]+=a)})}}),document.getElementById("total-hours-month").textContent=u.toFixed(2),ei(p),el(m),er(n)}catch(g){console.error("Failed to load dashboard data:",g),W("Impossibile caricare i dati della dashboard.")}finally{c.classList.add("hidden")}}function ei(e){let t=document.getElementById("employees-chart").getContext("2d"),a=Object.keys(e),n=Object.values(e);l=new Chart(t,{type:"bar",data:{labels:a,datasets:[{label:"Ore Lavorate",data:n,backgroundColor:"rgba(79, 70, 229, 0.8)",borderColor:"rgba(79, 70, 229, 1)",borderWidth:1}]},options:{responsive:!0,maintainAspectRatio:!1,scales:{y:{beginAtZero:!0}},plugins:{legend:{display:!1}}}})}function el(e){let t=document.getElementById("projects-chart").getContext("2d"),a=Object.keys(e).filter(t=>e[t]>0),n=Object.values(e).filter(e=>e>0),l=a.map((e,t)=>`hsl(${360*t/a.length}, 70%, 60%)`);i=new Chart(t,{type:"doughnut",data:{labels:a,datasets:[{label:"Ore per Progetto",data:n,backgroundColor:l,hoverOffset:4}]},options:{responsive:!0,maintainAspectRatio:!1,plugins:{legend:{position:"top"}}}})}function er(e){let t=document.getElementById("recent-activity-list");if(t.innerHTML="",!e||0===e.length){t.innerHTML='<li class="text-gray-500 text-center">Nessuna attivit\xe0 recente.</li>';return}let a=[];e.forEach(e=>{e.entries.forEach(t=>{a.push({employee:e.employeeName,type:t.type,time:t.time,date:e.date})})}),a.sort((e,t)=>{let a=new Date(`${e.date.split("T")[0]}T${e.time}`),n=new Date(`${t.date.split("T")[0]}T${t.time}`);return n-a}),a.slice(0,5).forEach(e=>{let a="check-in"===e.type,n=document.createElement("li");n.className="flex items-center justify-between p-2 bg-gray-50 rounded-md",n.innerHTML=`
                <div>
                    <p class="font-semibold">${e.employee}</p>
                    <p class="text-sm text-gray-600">
                        ha effettuato una timbratura di 
                        <span class="font-bold ${a?"text-green-600":"text-red-600"}">${a?"entrata":"uscita"}</span>.
                    </p>
                </div>
                <div class="text-right text-sm text-gray-500">
                    <p>${new Date(e.date.split("T")[0]).toLocaleDateString("it-IT")}</p>
                    <p>${e.time}</p>
                </div>
            `,t.appendChild(n)})}function es(){d&&clearInterval(d),eo(),d=setInterval(ed,15e3)}async function eo(){try{let e=await z.get("timesheets"),t=[];e.forEach(e=>{e.entries.forEach(a=>{t.push({...a,employeeName:e.employeeName,date:e.date})})}),t.sort((e,t)=>new Date(`${t.date.split("T")[0]}T${t.time}`)-new Date(`${e.date.split("T")[0]}T${e.time}`)),(r=t.slice(0,10)).length>0&&(o=r[0]._id),ec(!1)}catch(a){console.error("Failed to initialize notifications:",a)}}async function ed(){try{let e=await z.get("timesheets"),t=[];e.forEach(e=>{e.entries.forEach(a=>{t.push({...a,employeeName:e.employeeName,date:e.date})})}),t.sort((e,t)=>new Date(`${t.date.split("T")[0]}T${t.time}`)-new Date(`${e.date.split("T")[0]}T${e.time}`));let a=[];if(o){let n=t.findIndex(e=>e._id===o);n>0&&(a=t.slice(0,n))}else t.length>0&&(a=t.slice(0,5));a.length>0&&(s+=a.length,o=(r=[...a,...r].slice(0,20))[0]._id,ec(!0))}catch(i){console.error("Error polling for notifications:",i)}}function ec(e){s>0?(C.textContent=s,C.classList.remove("hidden")):C.classList.add("hidden"),r.length>0?F.innerHTML=r.map(e=>{let t="check-in"===e.type;return`
                <li class="p-3 hover:bg-gray-100 cursor-pointer text-sm">
                    <p class="font-semibold">${e.employeeName}</p>
                    <p class="text-gray-600">
                        Ha effettuato il <span class="font-bold ${t?"text-green-600":"text-red-600"}">${t?"check-in":"check-out"}</span>.
                    </p>
                    <p class="text-xs text-gray-400 mt-1">
                        ${new Date(`${e.date.split("T")[0]}T${e.time}`).toLocaleString("it-IT")}
                    </p>
                </li>
                `}).join(""):F.innerHTML='<li class="p-4 text-center text-gray-500">Nessuna notifica.</li>'}let ep=document.getElementById("new-employee-name"),em=document.getElementById("add-employee-btn"),eu=document.getElementById("employees-table-body");async function eg(){try{let e=await z.get("employees");if(eu.innerHTML="",0===e.length){eu.innerHTML='<tr><td colspan="3" class="text-center p-4 text-gray-500 border border-slate-300">Nessun dipendente ancora.</td></tr>';return}e.forEach(e=>{let t=document.createElement("tr");t.innerHTML=`
                    <td class="p-3 font-semibold border border-slate-300">${e.name}</td>
                    <td class="p-3 text-center border border-slate-300">${e.hasFaceDescriptor?'<span class="text-green-600 font-bold">Registrata</span>':'<span class="text-red-600 font-bold">Non Registrata</span>'}</td>
                    <td class="p-3 text-center space-x-2 border border-slate-300">
                        <button class="text-indigo-600 hover:text-indigo-900 register-face-btn" title="Registra impronta facciale" data-id="${e._id}" data-name="${e.name}">
                            <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 inline-block" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z" />
                                <path stroke-linecap="round" stroke-linejoin="round" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z" />
                            </svg>
                        </button>
                        <button class="text-gray-600 hover:text-gray-900 set-pin-btn" title="Imposta Codice PIN" data-id="${e._id}" data-name="${e.name}">
                             <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 inline-block" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
                            </svg>
                        </button>
                        <button class="text-red-600 hover:text-red-900 delete-employee-btn" title="Elimina Dipendente" data-id="${e._id}" data-name="${e.name}">
                            <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 inline-block" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                              <path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                            </svg>
                        </button>
                    </td>
                `,eu.appendChild(t)})}catch(t){}}async function e$(){let e=ep.value.trim().toUpperCase();if(!e)return W("Il nome del dipendente \xe8 obbligatorio.");try{await z.post("employees",{name:e}),W("Dipendente aggiunto con successo",!0),ep.value="",eg()}catch(t){}}async function ey(e,t){if(confirm(`Sei sicuro di voler eliminare il dipendente "${t}"? Tutti i suoi record verranno eliminati.`))try{await z.delete(`employees/${e}`),W("Dipendente eliminato con successo",!0),eg()}catch(a){}}eu.addEventListener("click",e=>{let t=e.target.closest("button");t&&(t.classList.contains("register-face-btn")?Y(t.dataset.name,t.dataset.id):t.classList.contains("delete-employee-btn")?ey(t.dataset.id,t.dataset.name):t.classList.contains("set-pin-btn")&&ee(t.dataset.id,t.dataset.name))});let eb=document.getElementById("add-user-form"),ev=document.getElementById("change-password-form"),eh=document.getElementById("users-table-body");async function ef(){try{let e=await z.get("users");if(eh.innerHTML="",0===e.length){eh.innerHTML='<tr><td colspan="3" class="text-center p-4 text-gray-500 border border-slate-300">Nessun utente.</td></tr>';return}e.forEach(e=>{let t=document.createElement("tr");t.innerHTML=`
                    <td class="p-3 border border-slate-300">${e.name}</td>
                    <td class="p-3 border border-slate-300">${e.email}</td>
                    <td class="p-3 text-center space-x-2 border border-slate-300">
                         <button class="text-blue-600 hover:text-blue-900 edit-user-btn" title="Modifica Utente" data-id="${e._id}" data-name="${e.name}" data-email="${e.email}">
                             <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 inline-block" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" />
                            </svg>
                         </button>
                        <button class="text-red-600 hover:text-red-900 delete-user-btn" title="Elimina Utente" data-id="${e._id}" data-name="${e.name}">
                             <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 inline-block" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                 <path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                            </svg>
                        </button>
                    </td>
                `,eh.appendChild(t)})}catch(t){}}async function eE(e){e.preventDefault();let t=document.getElementById("new-user-name").value.trim(),a=document.getElementById("new-user-email").value.trim(),n=document.getElementById("new-user-password").value;if(!t||!a||!n){W("Compila tutti i campi: Nome, Email, e Password.");return}try{await z.post("users/register",{name:t,email:a,password:n,username:a}),W("Utente aggiunto con successo!",!0),eb.reset(),ef()}catch(i){}}async function e0(e){e.preventDefault();let t=document.getElementById("update-password").value,a=document.getElementById("confirm-password").value;if(t!==a)return W("Le password non corrispondono.");try{await z.put("users/profile",{password:t}),W("Password aggiornata con successo!",!0),ev.reset()}catch(n){}}function eI(e){document.getElementById("edit-user-id").value=e.id,document.getElementById("edit-user-name").value=e.name,document.getElementById("edit-user-email").value=e.email,document.getElementById("edit-user-password").value="",S.classList.remove("hidden"),S.classList.add("flex")}function eL(){S.classList.add("hidden"),S.classList.remove("flex")}async function ew(e){e.preventDefault();let t=document.getElementById("edit-user-id").value,a=document.getElementById("edit-user-name").value,n=document.getElementById("edit-user-password").value,i={name:a};n&&(i.password=n);try{await z.put(`users/${t}`,i),W("Dati utente aggiornati con successo!",!0),eL(),ef()}catch(l){}}async function e9(e,t){if(confirm(`Sei sicuro di voler eliminare l'utente "${t}"?`))try{await z.delete(`users/${e}`),W("Utente eliminato con successo",!0),ef()}catch(a){}}eh.addEventListener("click",e=>{let t=e.target.closest("button");t&&(t.classList.contains("delete-user-btn")?e9(t.dataset.id,t.dataset.name):t.classList.contains("edit-user-btn")&&eI({id:t.dataset.id,name:t.dataset.name,email:t.dataset.email}))});let ex=document.getElementById("report-employee-select"),e_=document.getElementById("report-month-select"),eB=document.getElementById("report-year-select"),eT=document.getElementById("generate-report-btn"),ek=document.getElementById("report-output"),e1=document.getElementById("report-actions"),e4=["Gennaio","Febbraio","Marzo","Aprile","Maggio","Giugno","Luglio","Agosto","Settembre","Ottobre","Novembre","Dicembre"];function eS(e,t){if(!e||!/^\d{2}:\d{2}$/.test(e))return"";let[a,n]=e.split(":").map(Number);if("up"===t){let i=30*Math.ceil(n/30);60===i?(n=0,a=(a+1)%24):n=i}else{let l=30*Math.floor(n/30);n=l}return`${String(a).padStart(2,"0")}:${String(n).padStart(2,"0")}`}async function eM(){try{let e=await z.get("employees");ex.innerHTML='<option value="">-- Seleziona Dipendente --</option>',e.forEach(e=>{ex.innerHTML+=`<option value="${e.name}">${e.name}</option>`});let t=new Date,a=t.getFullYear(),n=t.getMonth();e_.innerHTML=e4.map((e,t)=>`<option value="${t}" ${t===n?"selected":""}>${e}</option>`).join(""),eB.innerHTML="";for(let i=a;i>=a-5;i--)eB.innerHTML+=`<option value="${i}">${i}</option>`}catch(l){}}async function e3(){let e=ex.value,t=parseInt(e_.value),a=parseInt(eB.value);if(!e)return W("Seleziona un dipendente.");let i=`${a}-${String(t+1).padStart(2,"0")}-01`,l=new Date(a,t+1,0).getDate(),r=`${a}-${String(t+1).padStart(2,"0")}-${String(l).padStart(2,"0")}`;ek.innerHTML='<div class="loader"></div>',e1.classList.add("hidden");try{let[s,o,d]=await Promise.all([z.get(`timesheets?employeeName=${e.toUpperCase()}&startDate=${i}&endDate=${r}`),z.get("holidays"),z.get(`leave?employeeName=${e.toUpperCase()}`)]);n=s;let c=new Map(o.map(e=>[e.date.split("T")[0],e.name])),p=new Set;d&&d.forEach(e=>{let t=new Date(e.startDate),a=new Date(e.endDate);for(;t<=a;)p.add(t.toISOString().split("T")[0]),t.setDate(t.getDate()+1)}),e2(s,e,e4[t],a,c,p)}catch(m){ek.innerHTML=`<p class="text-center text-red-500">Errore nel caricamento del report: ${m.message}</p>`}}function e2(e,t,a,n,i,l){let r=e4.indexOf(a),s=new Date(n,r+1,0).getDate(),o=["DOM","LUN","MAR","MER","GIO","VEN","SAB"],d=localStorage.getItem("companyLogo"),c=localStorage.getItem("companyName")||"Evolution Mec Srls",p="",m=0,u=0;for(let g=1;g<=s;g++){let $=new Date(Date.UTC(n,r,g)),y=$.toISOString().split("T")[0],b=o[$.getUTCDay()],v=`${String(g).padStart(2,"0")}/${String(r+1).padStart(2,"0")}`,h=e.find(e=>e.date.startsWith(y)),f=i.get(y),E=l.has(y),I=h?`<td class="p-2 border no-print"><button class="text-blue-600 edit-day-btn" data-timesheet-id="${h._id}">Modifica</button></td>`:'<td class="p-2 border no-print"></td>',L="";if(f){let w=`<td class="p-2 border font-semibold" colspan="11">${f}</td>`;L=`<tr class="bg-blue-50 text-center">
                    <td class="p-2 border">${v}</td>
                    <td class="p-2 border">${b}</td>
                    ${w}
                    ${I}
                </tr>`}else if(E)L=`<tr class="bg-green-50 text-center">
                    <td class="p-2 border">${v}</td>
                    <td class="p-2 border">${b}</td>
                    <td class="p-2 border font-semibold" colspan="11">Permesso / Ferie</td>
                    ${I}
                </tr>`;else if(h){m+=h.regularHours||0,u+=h.overtimeHours||0;let x=h.entries.filter(e=>"check-in"===e.type),_=h.entries.filter(e=>"check-out"===e.type),B=eS(x[0]?.time,"up"),T=eS(_[0]?.time,"down"),k=eS(x[1]?.time,"up"),S=eS(_[1]?.time,"down"),M=h.entries.map(e=>{let t=e.location?.name||"N/D",a="check-in"===e.type?"E":"U";return`${t} - ${e.time} (${a})`}).join("<br>"),H=[...new Set(h.entries.map(e=>e.project).filter(Boolean))].join(", "),D=[...new Set(h.entries.map(e=>e.description).filter(Boolean))].join(", ");L=`<tr class="text-center border-b">
                    <td class="p-2 border">${v}</td>
                    <td class="p-2 border">${b}</td>
                    <td class="p-2 border">${H}</td>
                    <td class="p-2 border">${D}</td>
                    <td class="p-2 border align-top text-left">${M}</td>
                    <td class="p-2 border">${B||""}</td>
                    <td class="p-2 border">${T||""}</td>
                    <td class="p-2 border">${k||""}</td>
                    <td class="p-2 border">${S||""}</td>
                    <td class="p-2 border">${(h.regularHours||0).toFixed(2)}</td>
                    <td class="p-2 border text-red-600">${(h.overtimeHours||0).toFixed(2)}</td>
                    <td class="p-2 border font-bold">${(h.totalHours||0).toFixed(2)}</td>
                    ${I}
                </tr>`}else{let C='<td class="p-2 border">&nbsp;</td>'.repeat(11);L=`<tr class="bg-gray-50">
                    <td class="p-2 border">${v}</td>
                    <td class="p-2 border">${b}</td>
                    ${C}
                    ${I}
                </tr>`}p+=L}ek.innerHTML=`
            <div id="employee-report-to-export" class="bg-white p-6 printable-area">
                <header class="flex justify-between items-start pb-4 border-b mb-6">
                     <div class="w-1/4">
                         ${d?`<img src="${d}" alt="Logo Aziendale" class="h-16">`:""}
                     </div>
                    <div class="w-1/2 text-center">
                        <h2 class="text-2xl font-bold text-gray-800">${c}</h2>
                        <p class="text-gray-500">Riepilogo Ore Lavorative</p>
                    </div>
                    <div class="w-1/4 text-right text-sm">
                        <p><strong>Dipendente:</strong> ${t}</p>
                        <p><strong>Mese:</strong> ${a} ${n}</p>
                        <p><strong>Data Stampa:</strong> ${new Date().toLocaleDateString("it-IT")}</p>
                    </div>
                </header>
                <main>
                    <div class="report-table-container">
                        <table class="w-full text-xs" id="employee-report-table">
                            <thead class="bg-gray-100">
                                <tr>
                                    <th class="p-2 border">Data</th><th class="p-2 border">Giorno</th><th class="p-2 border">Commessa</th>
                                    <th class="p-2 border">Descrizione</th><th class="p-2 border">Luogo (GPS) e Orari Effettivi</th>
                                    <th class="p-2 border">Entrata</th><th class="p-2 border">Uscita</th>
                                    <th class="p-2 border">Entrata</th><th class="p-2 border">Uscita</th>
                                    <th class="p-2 border">Ord.</th><th class="p-2 border">Straord.</th><th class="p-2 border">Totale</th>
                                    <th class="p-2 border no-print">Azione</th>
                                </tr>
                            </thead>
                            <tbody>${p}</tbody>
                        </table>
                    </div>
                </main>
                <footer class="mt-8 pt-4 border-t text-sm">
                    <div class="flex justify-between items-end">
                        <div class="font-bold">
                            <p>Totale Ore Ordinarie: <span class="text-blue-700">${m.toFixed(2)}</span></p>
                            <p>Totale Ore Straordinario: <span class="text-red-700">${u.toFixed(2)}</span></p>
                        </div>
                        <div class="text-center">
                            <p class="mb-12">Firma del Dipendente</p>
                            <p class="border-t pt-2">_________________________</p>
                        </div>
                    </div>
                </footer>
            </div>
        `,e1.classList.remove("hidden")}function eH(){let e=document.getElementById("employee-report-to-export"),t=ex.value;e&&html2canvas(e,{scale:3,useCORS:!0,windowWidth:e.scrollWidth,windowHeight:e.scrollHeight}).then(e=>{let a=document.createElement("a");a.download=`Riepilogo-${t}-${new Date().toISOString().slice(0,10)}.png`,a.href=e.toDataURL("image/png"),a.click()})}function eD(){let{jsPDF:e}=window.jspdf,t=document.getElementById("employee-report-table");if(!t)return;let a=new e({orientation:"landscape",unit:"mm",format:"a4"}),n=e_.options[e_.selectedIndex].text,i=eB.value,l=ex.value,r=localStorage.getItem("companyName")||"Evolution Mec Srls";a.autoTable({html:"#employee-report-table",startY:42,theme:"grid",margin:{top:42,right:10,bottom:40,left:10},headStyles:{fillColor:[230,230,230],textColor:[30,30,30],fontStyle:"bold",lineWidth:.1,lineColor:[200,200,200]},styles:{fontSize:7,cellPadding:1.5,lineWidth:.1,lineColor:[200,200,200],valign:"middle"},columnStyles:{2:{overflow:"linebreak"},3:{overflow:"linebreak"},4:{overflow:"linebreak",halign:"left",cellWidth:50},10:{fontStyle:"bold",textColor:[200,0,0]},11:{fontStyle:"bold"}},didDrawPage(e){let t=localStorage.getItem("companyLogo");if(t)try{a.addImage(t,"PNG",14,15,30,15)}catch(s){console.error("Error adding logo to PDF:",s)}a.setFontSize(18),a.setFont("helvetica","bold"),a.text(r,148,20,{align:"center"}),a.setFontSize(11),a.setFont("helvetica","normal"),a.text("Riepilogo Ore Lavorative",148,28,{align:"center"}),a.setFontSize(10),a.text(`Dipendente: ${l}`,287,20,{align:"right"}),a.text(`Mese: ${n} ${i}`,287,26,{align:"right"}),a.text(`Data Stampa: ${new Date().toLocaleDateString("it-IT")}`,287,32,{align:"right"}),a.setLineWidth(.5),a.line(10,38,287,38)},didParseCell:function(e){"body"===e.cell.section&&4===e.column.index&&e.cell.raw&&(e.cell.text=e.cell.raw.innerText.split("\n"))}});let s=a.lastAutoTable.finalY>160?160:a.lastAutoTable.finalY,o=document.querySelector("#employee-report-to-export footer .font-bold"),d=o.children[0].textContent,c=o.children[1].textContent;a.setFontSize(12),a.setFont("helvetica","bold"),a.text(d,14,s+15),a.text(c,14,s+22),a.setFontSize(10),a.setFont("helvetica","normal"),a.text("Firma del Dipendente",287,s+20,{align:"right"}),a.setLineWidth(.2),a.line(224,s+30,287,s+30),a.save(`Riepilogo-${l}-${n}-${i}.pdf`)}async function eC(){let e=document.getElementById("holidays-table-body");try{let t=await z.get("holidays");e.innerHTML=t.map(e=>`
                <tr>
                    <td class="p-2 border border-slate-300">${e.name}</td>
                    <td class="p-2 border border-slate-300">${new Date(e.date).toLocaleDateString("it-IT")}</td>
                    <td class="p-2 text-center border border-slate-300"><button class="text-red-500 delete-holiday-btn" data-id="${e._id}">Elimina</button></td>
                </tr>
            `).join("")}catch(a){e.innerHTML='<tr><td colspan="3" class="text-center p-4 text-red-500">Errore nel caricamento.</td></tr>'}}async function ej(){let e=document.getElementById("holiday-name-input").value.trim(),t=document.getElementById("holiday-date-input").value;if(!e||!t)return W("Nome e data sono obbligatori.");try{await z.post("holidays",{name:e,date:t}),W("Festivit\xe0 aggiunta con successo!",!0),eC(),document.getElementById("holiday-name-input").value="",document.getElementById("holiday-date-input").value=""}catch(a){}}async function e8(e){if(e.target.classList.contains("delete-holiday-btn")&&confirm("Sei sicuro di voler eliminare questa festivit\xe0?"))try{await z.delete(`holidays/${e.target.dataset.id}`),W("Festivit\xe0 eliminata!",!0),eC()}catch(t){}}async function eF(){let e=document.getElementById("leave-employee-select");try{let t=await z.get("employees");e.innerHTML='<option value="">-- Seleziona --</option>'+t.map(e=>`<option value="${e.name}">${e.name}</option>`).join("")}catch(a){}}async function eN(){let e=document.getElementById("leave-table-body");try{let t=await z.get("leave");e.innerHTML=t.map(e=>`
                <tr>
                    <td class="p-2 border border-slate-300">${e.employeeName}</td>
                    <td class="p-2 border border-slate-300">${e.leaveType}</td>
                    <td class="p-2 border border-slate-300">${new Date(e.startDate).toLocaleDateString("it-IT")}</td>
                    <td class="p-2 border border-slate-300">${new Date(e.endDate).toLocaleDateString("it-IT")}</td>
                    <td class="p-2 text-center border border-slate-300"><button class="text-red-500 delete-leave-btn" data-id="${e._id}">Elimina</button></td>
                </tr>
            `).join("")}catch(a){e.innerHTML='<tr><td colspan="5" class="text-center p-4 text-red-500">Errore nel caricamento.</td></tr>'}}async function e6(){let e=document.getElementById("leave-employee-select").value,t=document.getElementById("leave-type-input").value.trim(),a=document.getElementById("leave-start-date-input").value,n=document.getElementById("leave-end-date-input").value;if(!e||!t||!a||!n)return W("Tutti i campi sono obbligatori.");try{await z.post("leave",{employeeName:e,leaveType:t,startDate:a,endDate:n}),W("Permesso/Ferie aggiunto con successo!",!0),eN()}catch(i){}}async function e5(e){if(e.target.classList.contains("delete-leave-btn")&&confirm("Sei sicuro di voler eliminare questo record?"))try{await z.delete(`leave/${e.target.dataset.id}`),W("Record eliminato!",!0),eN()}catch(t){}}let ez=document.getElementById("edit-day-modal"),eO=document.getElementById("edit-entries-container");function e7(e){let t=n.find(t=>t._id===e);if(!t)return;let a=new Date(t.date),i=6e4*a.getTimezoneOffset(),l=new Date(a.getTime()+i);document.getElementById("edit-day-modal-title").textContent=`Modifica Orari del Giorno: ${l.toLocaleDateString("it-IT")}`,eO.innerHTML="",t.entries.length>0?t.entries.forEach(e=>eA(e)):eA(),document.getElementById("save-day-edits-btn").dataset.timesheetId=e,ez.classList.remove("hidden"),ez.classList.add("flex")}function eA(e={}){let t=document.createElement("div");t.className="grid grid-cols-5 gap-3 items-center border-b pb-3",t.dataset.entryId=e._id||`new_${Date.now()}`,t.innerHTML=`
            <select class="p-1 border rounded edit-type"><option value="check-in" ${"check-in"===e.type?"selected":""}>Entrata</option><option value="check-out" ${"check-out"===e.type?"selected":""}>Uscita</option></select>
            <div><input type="time" value="${e.time||""}" class="w-full p-1 border rounded edit-time"></div>
            <div><input type="text" value="${e.project||""}" class="w-full p-1 border rounded edit-project" placeholder="Progetto"></div>
            <div><input type="text" value="${e.description||""}" class="w-full p-1 border rounded edit-description" placeholder="Descrizione"></div>
            <button class="text-red-500 remove-entry-row-btn p-1 rounded hover:bg-red-100">Rimuovi</button>
        `,eO.appendChild(t)}function eP(){ez.classList.add("hidden"),ez.classList.remove("flex")}async function eR(){let e=document.getElementById("save-day-edits-btn").dataset.timesheetId,t=n.find(t=>t._id===e),a=Array.from(eO.children).map(e=>{let a=e.dataset.entryId,n=t.entries.find(e=>e._id===a)||{};return{_id:a.startsWith("new_")?void 0:a,type:e.querySelector(".edit-type").value,time:e.querySelector(".edit-time").value,project:e.querySelector(".edit-project").value,description:e.querySelector(".edit-description").value,location:n.location||{name:"Modifica Manuale"}}}).filter(e=>e.time);try{await z.put(`timesheets/${e}`,{entries:a}),W("Modifiche salvate con successo!",!0),eP(),e3()}catch(i){W("Salvataggio fallito: "+i.message)}}async function eU(){try{let[e,t]=await Promise.all([z.get("clients"),z.get("projects")]),a=document.getElementById("clients-table-body");a.innerHTML="",e.length>0?e.forEach(e=>{a.innerHTML+=`<tr><td class="p-2 border border-slate-300">${e.name}</td><td class="p-2 border border-slate-300">${e.email||""}</td><td class="p-2 border border-slate-300"><button class="text-red-500 delete-client-btn" data-id="${e._id}" data-name="${e.name}">Elimina</button></td></tr>`}):a.innerHTML='<tr><td colspan="3" class="text-center p-4 border border-slate-300">Nessun cliente</td></tr>';let n=document.getElementById("projects-table-body");n.innerHTML="",t.length>0?t.forEach(e=>{n.innerHTML+=`<tr><td class="p-2 border border-slate-300">${e.name}</td><td class="p-2 border border-slate-300">${e.clientName}</td><td class="p-2 border border-slate-300"><button class="text-red-500 delete-project-btn" data-id="${e._id}" data-name="${e.name}">Elimina</button></td></tr>`}):n.innerHTML='<tr><td colspan="3" class="text-center p-4 border border-slate-300">Nessun progetto</td></tr>';let i=document.getElementById("project-client-select");i.innerHTML='<option value="">-- Seleziona Cliente --</option>',e.forEach(e=>{i.innerHTML+=`<option value="${e.name}">${e.name}</option>`})}catch(l){}}function eq(){let e=document.getElementById("logo-preview"),t=document.getElementById("company-name-input"),a=localStorage.getItem("companyLogo"),n=localStorage.getItem("companyName");a?e.src=a:e.src="",n&&(t.value=n)}function eW(){u.addEventListener("submit",O),y.addEventListener("click",A),b.forEach(e=>e.addEventListener("click",e=>q(e))),em.addEventListener("click",e$),_.addEventListener("click",Z),x.addEventListener("click",X),eb.addEventListener("submit",eE),ev.addEventListener("submit",e0),eT.addEventListener("click",e3),T.addEventListener("click",ea),k.addEventListener("click",et),M.addEventListener("submit",ew),H.addEventListener("click",eL),D.addEventListener("click",()=>{j.classList.toggle("hidden"),j.classList.contains("hidden")||(s=0,ec(!1))}),document.addEventListener("click",e=>{D.contains(e.target)||j.contains(e.target)||j.classList.add("hidden")}),document.getElementById("print-report-btn").addEventListener("click",()=>window.print()),document.getElementById("export-png-btn").addEventListener("click",eH),document.getElementById("export-pdf-btn").addEventListener("click",eD),document.getElementById("clients-table-body").addEventListener("click",async e=>{if(e.target.classList.contains("delete-client-btn")){let{id:t,name:a}=e.target.dataset;confirm(`Sei sicuro di eliminare il cliente "${a}" e tutti i suoi progetti?`)&&(await z.delete(`clients/${t}`),eU())}}),document.getElementById("projects-table-body").addEventListener("click",async e=>{if(e.target.classList.contains("delete-project-btn")){let{id:t,name:a}=e.target.dataset;confirm(`Sei sicuro di eliminare il progetto "${a}"?`)&&(await z.delete(`projects/${t}`),eU())}}),document.getElementById("add-client-btn").addEventListener("click",async()=>{let e=document.getElementById("client-name-input").value,t=document.getElementById("client-email-input").value;if(!e)return W("Il nome del cliente \xe8 obbligatorio.");await z.post("clients",{name:e,email:t}),eU(),document.getElementById("client-name-input").value="",document.getElementById("client-email-input").value=""}),document.getElementById("add-project-btn").addEventListener("click",async()=>{let e=document.getElementById("project-name-input").value,t=document.getElementById("project-client-select").value,a=document.getElementById("project-rate-input").value;if(!e||!t||!a)return W("Tutti i campi del progetto sono obbligatori.");await z.post("projects",{name:e,clientName:t,rate:a}),eU(),document.getElementById("project-name-input").value="",document.getElementById("project-client-select").value="",document.getElementById("project-rate-input").value=""}),ek.addEventListener("click",e=>{let t=e.target.closest(".edit-day-btn");t&&e7(t.dataset.timesheetId)}),document.getElementById("cancel-edit-day-btn").addEventListener("click",eP),document.getElementById("save-day-edits-btn").addEventListener("click",eR),document.getElementById("add-entry-row-btn").addEventListener("click",()=>eA()),eO.addEventListener("click",e=>{e.target.classList.contains("remove-entry-row-btn")&&e.target.parentElement.remove()}),document.getElementById("add-holiday-btn").addEventListener("click",ej),document.getElementById("holidays-table-body").addEventListener("click",e8),document.getElementById("add-leave-btn").addEventListener("click",e6),document.getElementById("leave-table-body").addEventListener("click",e5),P()}document.getElementById("logo-upload-input").addEventListener("change",e=>{let t=e.target.files[0];if(t){let a=new FileReader;a.onload=e=>{document.getElementById("logo-preview").src=e.target.result},a.readAsDataURL(t)}}),document.getElementById("save-settings-btn").addEventListener("click",()=>{let e=document.getElementById("logo-preview").src,t=document.getElementById("company-name-input").value.trim();t?localStorage.setItem("companyName",t):localStorage.removeItem("companyName"),e&&!e.endsWith("#")&&e.startsWith("data:image")&&localStorage.setItem("companyLogo",e),W("Impostazioni salvate con successo!",!0)}),document.getElementById("remove-logo-btn").addEventListener("click",()=>{localStorage.removeItem("companyLogo"),document.getElementById("logo-preview").src="",W("Logo rimosso.",!0)}),eW()});