<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>لوحة تحكم المدير</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap');
        body { font-family: 'Cairo', sans-serif; }
        .sidebar-link { transition: all 0.2s ease; }
        .sidebar-link.active { background-color: #4f46e5; color: white; }
        .sidebar-link:hover { background-color: #3730a3; color: white; }
        .modal { transition: opacity 0.3s ease; }
        .modal-content { transition: transform 0.3s ease, opacity 0.3s ease; }
        .loader {
            border: 4px solid #f3f3f3; border-radius: 50%;
            border-top: 4px solid #4f46e5; width: 40px; height: 40px;
            animation: spin 2s linear infinite; margin: 20px auto;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-gray-100">

    <div id="loading-overlay" class="fixed inset-0 bg-black bg-opacity-75 z-[100] flex flex-col items-center justify-center">
        <div class="loader"></div>
        <p class="text-white text-lg mt-4">جاري تحميل النظام...</p>
    </div>

    <div class="flex h-screen bg-gray-100">
        <!-- Sidebar -->
        <aside class="w-64 bg-gray-800 text-white flex flex-col">
            <div class="h-20 flex items-center justify-center text-2xl font-bold border-b border-gray-700">
                لوحة التحكم
            </div>
            <nav class="flex-grow">
                <a href="#dashboard" class="sidebar-link flex items-center py-4 px-6 active">
                    <svg class="w-6 h-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path></svg>
                    <span>نظرة عامة</span>
                </a>
                <a href="#employees" class="sidebar-link flex items-center py-4 px-6">
                    <svg class="w-6 h-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M15 21a6 6 0 00-9-5.197m0 0A5.995 5.995 0 0012 12.75a5.995 5.995 0 00-3-5.197m0 0A4 4 0 0112 4.354a4 4 0 013 5.197m-3 0a4 4 0 00-3-5.197m0 0A4 4 0 006 9.646"></path></svg>
                    <span>الموظفون</span>
                </a>
                <a href="#clients" class="sidebar-link flex items-center py-4 px-6">
                     <svg class="w-6 h-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path></svg>
                    <span>العملاء والمشاريع</span>
                </a>
                <a href="#reports" class="sidebar-link flex items-center py-4 px-6">
                    <svg class="w-6 h-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                    <span>التقارير</span>
                </a>
            </nav>
            <div class="p-4 border-t border-gray-700">
                 <div id="server-status" class="flex items-center gap-2 text-sm">
                    <div id="status-indicator" class="w-3 h-3 rounded-full bg-yellow-400 animate-pulse"></div>
                    <span id="status-text">جاري التحقق...</span>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 p-10 overflow-auto">
            <!-- Dashboard Section -->
            <section id="dashboard" class="page-section">
                <h1 class="text-3xl font-bold mb-8">نظرة عامة</h1>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
                    <div class="bg-white p-6 rounded-lg shadow-md flex items-center">
                        <div class="bg-blue-500 text-white p-4 rounded-full mr-6">
                            <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M15 21a6 6 0 00-9-5.197m0 0A5.995 5.995 0 0012 12.75a5.995 5.995 0 00-3-5.197m0 0A4 4 0 0112 4.354a4 4 0 013 5.197m-3 0a4 4 0 00-3-5.197m0 0A4 4 0 006 9.646"></path></svg>
                        </div>
                        <div>
                            <h3 class="text-gray-500 text-lg font-bold">إجمالي الموظفين</h3>
                            <p id="total-employees" class="text-4xl font-bold">0</p>
                        </div>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow-md flex items-center">
                         <div class="bg-green-500 text-white p-4 rounded-full mr-6">
                            <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path></svg>
                        </div>
                        <div>
                            <h3 class="text-gray-500 text-lg font-bold">إجمالي العملاء</h3>
                            <p id="total-clients" class="text-4xl font-bold">0</p>
                        </div>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow-md flex items-center">
                         <div class="bg-purple-500 text-white p-4 rounded-full mr-6">
                           <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 13.255A23.931 23.931 0 0112 15c-3.183 0-6.22-.62-9-1.745M16 6V4a2 2 0 00-2-2h-4a2 2 0 00-2 2v2m4 6h.01M5 20h14a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path></svg>
                        </div>
                        <div>
                            <h3 class="text-gray-500 text-lg font-bold">إجمالي المشاريع</h3>
                            <p id="total-projects" class="text-4xl font-bold">0</p>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Employees Section -->
            <section id="employees" class="page-section hidden">
                <h1 class="text-3xl font-bold mb-8">إدارة الموظفين</h1>
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <div class="flex gap-4 mb-6">
                        <input type="text" id="employee-name-input" placeholder="اسم الموظف الجديد" class="flex-grow p-3 border rounded-md">
                        <button id="add-employee-btn" class="bg-indigo-600 text-white px-6 py-3 rounded-lg font-bold hover:bg-indigo-700">إضافة موظف</button>
                    </div>
                    <div id="employees-table-container" class="overflow-auto">
                        <table class="w-full text-sm">
                            <thead class="bg-gray-100">
                                <tr>
                                    <th class="p-3 text-right">اسم الموظف</th>
                                    <th class="p-3">حالة بصمة الوجه</th>
                                    <th class="p-3">إجراءات</th>
                                </tr>
                            </thead>
                            <tbody id="employees-table-body"></tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- Clients & Projects Section -->
            <section id="clients" class="page-section hidden">
                 <h1 class="text-3xl font-bold mb-8">إدارة العملاء والمشاريع</h1>
                 <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <!-- Clients Management -->
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <h2 class="text-xl font-bold mb-4">العملاء</h2>
                        <div class="space-y-4 mb-6">
                            <input type="text" id="client-name-input" placeholder="اسم العميل" class="w-full p-3 border rounded-md">
                            <input type="email" id="client-email-input" placeholder="البريد الإلكتروني" class="w-full p-3 border rounded-md">
                            <input type="text" id="client-phone-input" placeholder="رقم الهاتف" class="w-full p-3 border rounded-md">
                            <button id="add-client-btn" class="w-full bg-cyan-600 text-white p-3 rounded-lg font-bold hover:bg-cyan-700">إضافة عميل</button>
                        </div>
                        <div id="clients-table-container" class="max-h-64 overflow-auto">
                            <table class="w-full text-sm">
                                <thead class="bg-gray-100 sticky top-0"><tr><th class="p-2 text-right">العميل</th><th class="p-2">إجراء</th></tr></thead>
                                <tbody id="clients-table-body"></tbody>
                            </table>
                        </div>
                    </div>
                    <!-- Projects Management -->
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <h2 class="text-xl font-bold mb-4">المشاريع</h2>
                        <div class="space-y-4 mb-6">
                            <input type="text" id="project-name-input" placeholder="اسم المشروع" class="w-full p-3 border rounded-md">
                            <select id="project-client-select" class="w-full p-3 border rounded-md bg-white"><option value="">-- اختر العميل --</option></select>
                            <input type="number" id="project-rate-input" placeholder="سعر الساعة" class="w-full p-3 border rounded-md">
                            <button id="add-project-btn" class="w-full bg-green-600 text-white p-3 rounded-lg font-bold hover:bg-green-700">إضافة مشروع</button>
                        </div>
                        <div id="projects-table-container" class="max-h-64 overflow-auto">
                            <table class="w-full text-sm">
                                <thead class="bg-gray-100 sticky top-0"><tr><th class="p-2 text-right">المشروع</th><th class="p-2">العميل</th><th class="p-2">إجراء</th></tr></thead>
                                <tbody id="projects-table-body"></tbody>
                            </table>
                        </div>
                    </div>
                 </div>
            </section>
            
            <!-- Reports Section -->
            <section id="reports" class="page-section hidden">
                 <h1 class="text-3xl font-bold mb-8">التقارير</h1>
                 <div class="bg-white p-6 rounded-lg shadow-md">
                     <div class="flex flex-wrap gap-4 items-end mb-6 border-b pb-6">
                        <div class="flex-grow">
                            <label for="report-employee-select" class="block text-sm font-medium mb-1">الموظف:</label>
                            <select id="report-employee-select" class="w-full p-3 border rounded-md bg-white"></select>
                        </div>
                        <div class="flex-grow">
                            <label for="report-type-select" class="block text-sm font-medium mb-1">نوع التقرير:</label>
                            <select id="report-type-select" class="w-full p-3 border rounded-md bg-white">
                                <option value="monthly">شهري</option>
                                <option value="yearly">سنوي</option>
                            </select>
                        </div>
                        <div id="month-year-picker" class="flex-grow">
                            <label for="month-picker" class="block text-sm font-medium mb-1">اختر الشهر:</label>
                            <input type="month" id="month-picker" class="w-full p-3 border rounded-md">
                        </div>
                         <div id="year-picker" class="flex-grow hidden">
                            <label for="year-picker-input" class="block text-sm font-medium mb-1">اختر السنة:</label>
                            <input type="number" id="year-picker-input" class="w-full p-3 border rounded-md" placeholder="YYYY">
                        </div>
                        <button id="generate-report-btn" class="bg-blue-600 text-white px-6 py-3 rounded-lg font-bold hover:bg-blue-700">إنشاء تقرير</button>
                    </div>
                    <div id="report-results-container" class="space-y-4 max-h-[60vh] overflow-auto p-2">
                        <p id="report-placeholder" class="text-center text-gray-500 my-8">الرجاء تحديد معايير البحث لعرض تقرير.</p>
                        <!-- Detailed records will be injected here -->
                    </div>
                 </div>
            </section>
        </main>
    </div>
    
    <!-- Modals -->
    <div id="alert-modal" class="modal fixed inset-0 bg-gray-800 bg-opacity-50 hidden items-center justify-center z-50 p-4">
        <div id="alert-modal-content" class="modal-content bg-white p-6 sm:p-8 rounded-lg shadow-xl w-full max-w-md"></div>
    </div>
    <div id="face-modal" class="modal fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50 p-4">
        <div class="modal-content bg-white rounded-lg shadow-xl w-full max-w-sm p-6 text-center">
            <h3 id="face-modal-title" class="text-lg font-bold mb-4">تسجيل بصمة الوجه</h3>
            <div class="relative mx-auto bg-gray-200 w-full aspect-square rounded-md mb-4">
                <video id="video" class="w-full h-full rounded-md" autoplay muted playsinline></video>
                <canvas id="overlay" class="absolute top-0 left-0 w-full h-full"></canvas>
            </div>
            <p id="status-message" class="mb-4 h-6">الرجاء توجيه الوجه للكاميرا...</p>
            <button id="action-btn" class="w-full bg-green-500 text-white py-2 rounded-lg hover:bg-green-600 transition disabled:bg-gray-400" disabled>تسجيل</button>
            <button id="cancel-btn" class="w-full bg-gray-500 text-white py-2 rounded-lg hover:bg-gray-600 transition mt-2">إلغاء</button>
        </div>
    </div>

    <script>
        // --- All functions are defined first ---
        const API_URL = 'http://localhost:5000/api';
        let employeesCache = [];
        let clientsCache = [];
        let projectsCache = [];
        let currentStream = null;
        let faceDetectionInterval = null;
        let faceApiReady = false;

        // --- API Layer ---
        const api = {
            async get(endpoint, showError = true) {
                try {
                    const response = await fetch(`${API_URL}/${endpoint}`);
                    if (!response.ok) throw new Error(`Server Error: ${response.statusText}`);
                    return await response.json();
                } catch (error) {
                    if (showError) showAlert(`فشل جلب البيانات: ${error.message}`);
                    throw error;
                }
            },
            async post(endpoint, body) {
                try {
                    const response = await fetch(`${API_URL}/${endpoint}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(body),
                    });
                    if (!response.ok) {
                        const errData = await response.json();
                        throw new Error(errData.message || response.statusText);
                    }
                    return await response.json();
                } catch (error) {
                    showAlert(`فشل الإرسال: ${error.message}`);
                    return null;
                }
            },
            async delete(endpoint) {
                try {
                    const response = await fetch(`${API_URL}/${endpoint}`, { method: 'DELETE' });
                    const payload = await response.json();
                    if (!response.ok) throw new Error(payload.message);
                    return payload;
                } catch (error) {
                    showAlert(`فشل الحذف: ${error.message}`);
                    return null;
                }
            }
        };

        // --- Modals ---
        function showAlert(message, duration = 0) {
            const alertModal = document.getElementById('alert-modal');
            const alertModalContent = document.getElementById('alert-modal-content');
            alertModalContent.innerHTML = `<p>${message}</p>`;
            if (duration === 0) {
                alertModalContent.innerHTML += `<div class="mt-4 text-left"><button id="alert-ok-btn" class="bg-blue-600 text-white px-4 py-2 rounded">موافق</button></div>`;
                document.getElementById('alert-ok-btn').onclick = () => alertModal.classList.add('hidden');
            }
            alertModal.classList.remove('hidden');
            alertModal.classList.add('flex');
            if (duration > 0) setTimeout(() => alertModal.classList.add('hidden'), duration);
        }

        // --- Server Status ---
        async function checkServerStatus() {
            const indicator = document.getElementById('status-indicator');
            const text = document.getElementById('status-text');
            try {
                await api.get('employees', false);
                indicator.classList.remove('bg-yellow-400', 'bg-red-500', 'animate-pulse');
                indicator.classList.add('bg-green-500');
                text.textContent = 'الخادم متصل';
            } catch (error) {
                indicator.classList.remove('bg-yellow-400', 'bg-green-500', 'animate-pulse');
                indicator.classList.add('bg-red-500');
                text.textContent = 'الخادم متوقف';
            }
        }

        // --- Navigation ---
        function handleNavigation() {
            const links = document.querySelectorAll('.sidebar-link');
            const sections = document.querySelectorAll('.page-section');
            
            function setActiveLink(hash) {
                links.forEach(link => {
                    link.classList.toggle('active', link.hash === hash);
                });
                sections.forEach(section => {
                    section.classList.toggle('hidden', section.id !== hash.substring(1));
                });
            }

            window.addEventListener('hashchange', () => setActiveLink(window.location.hash || '#dashboard'));
            setActiveLink(window.location.hash || '#dashboard');
        }

        // --- Dashboard Logic ---
        async function loadDashboardData() {
            [employeesCache, clientsCache, projectsCache] = await Promise.all([
                api.get('employees'),
                api.get('clients'),
                api.get('projects')
            ]);
            
            document.getElementById('total-employees').textContent = employeesCache.length;
            document.getElementById('total-clients').textContent = clientsCache.length;
            document.getElementById('total-projects').textContent = projectsCache.length;

            loadEmployeesTable();
            loadClientsTable();
            loadProjectsTable();
            updateClientDropdown();
            updateReportEmployeeDropdown();
        }

        // --- Employee Management ---
        async function addEmployee() {
            const nameInput = document.getElementById('employee-name-input');
            const name = nameInput.value.trim().toUpperCase();
            if (!name) return showAlert('اسم الموظف مطلوب.');
            
            const result = await api.post('employees', { name });
            if (result) {
                showAlert('تمت إضافة الموظف بنجاح.', 1500);
                nameInput.value = '';
                loadDashboardData();
            }
        }

        function loadEmployeesTable() {
            const tableBody = document.getElementById('employees-table-body');
            tableBody.innerHTML = '';
            employeesCache.forEach(emp => {
                const faceStatus = emp.faceDescriptor && emp.faceDescriptor.length > 0
                    ? '<span class="text-green-600 font-bold">مسجلة</span>'
                    : '<span class="text-yellow-600 font-bold">غير مسجلة</span>';
                tableBody.innerHTML += `
                    <tr data-id="${emp._id}" data-name="${emp.name}">
                        <td class="p-3 text-right">${emp.name}</td>
                        <td class="p-3">${faceStatus}</td>
                        <td class="p-3 text-center flex justify-center items-center gap-2">
                            <button class="text-indigo-500 hover:text-indigo-700 register-face-btn" title="تسجيل بصمة الوجه">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M15 21a6 6 0 00-9-5.197m0 0A5.995 5.995 0 0012 12.75a5.995 5.995 0 00-3-5.197m0 0A4 4 0 0112 4.354a4 4 0 013 5.197m-3 0a4 4 0 00-3-5.197m0 0A4 4 0 006 9.646"></path></svg>
                            </button>
                            <button class="text-red-500 hover:text-red-700 delete-employee-btn" title="حذف الموظف">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                            </button>
                        </td>
                    </tr>
                `;
            });
        }
        
        // --- Client Management ---
        async function addClient() {
            const nameInput = document.getElementById('client-name-input');
            const name = nameInput.value.trim();
            if(!name) return showAlert('اسم العميل مطلوب.');

            const result = await api.post('clients', {
                name,
                email: document.getElementById('client-email-input').value.trim(),
                phone: document.getElementById('client-phone-input').value.trim(),
            });

            if (result) {
                showAlert('تمت إضافة العميل بنجاح.', 1500);
                nameInput.value = '';
                document.getElementById('client-email-input').value = '';
                document.getElementById('client-phone-input').value = '';
                loadDashboardData();
            }
        }

        function loadClientsTable() {
            const tableBody = document.getElementById('clients-table-body');
            tableBody.innerHTML = '';
            clientsCache.forEach(client => {
                tableBody.innerHTML += `
                    <tr data-id="${client._id}" data-name="${client.name}">
                        <td class="p-2 text-right">${client.name}</td>
                        <td class="p-2 text-center">
                             <button class="text-red-500 hover:text-red-700 delete-client-btn" title="حذف العميل">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                            </button>
                        </td>
                    </tr>
                `;
            });
        }

        // --- Project Management ---
        async function addProject() {
            const nameInput = document.getElementById('project-name-input');
            const clientSelect = document.getElementById('project-client-select');
            const rateInput = document.getElementById('project-rate-input');
            const name = nameInput.value.trim();
            const clientName = clientSelect.value;
            const rate = parseFloat(rateInput.value);

            if (!name || !clientName || isNaN(rate)) return showAlert('الرجاء تعبئة جميع حقول المشروع.');

            const result = await api.post('projects', { name, clientName, rate });
            if (result) {
                showAlert('تمت إضافة المشروع بنجاح.', 1500);
                nameInput.value = '';
                clientSelect.value = '';
                rateInput.value = '';
                loadDashboardData();
            }
        }

        function loadProjectsTable() {
            const tableBody = document.getElementById('projects-table-body');
            tableBody.innerHTML = '';
            projectsCache.forEach(proj => {
                tableBody.innerHTML += `
                     <tr data-id="${proj._id}" data-name="${proj.name}">
                        <td class="p-2 text-right">${proj.name}</td>
                        <td class="p-2">${proj.clientName}</td>
                        <td class="p-2 text-center">
                            <button class="text-red-500 hover:text-red-700 delete-project-btn" title="حذف المشروع">
                               <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                            </button>
                        </td>
                    </tr>
                `;
            });
        }
        
        function updateClientDropdown() {
            const select = document.getElementById('project-client-select');
            select.innerHTML = '<option value="">-- اختر العميل --</option>';
            clientsCache.forEach(client => {
                select.innerHTML += `<option value="${client.name}">${client.name}</option>`;
            });
        }

        function updateReportEmployeeDropdown() {
            const select = document.getElementById('report-employee-select');
            select.innerHTML = '<option value="">-- اختر الموظف --</option>';
            employeesCache.forEach(emp => {
                select.innerHTML += `<option value="${emp.name}">${emp.name}</option>`;
            });
        }

        // --- Event Handlers ---
        async function handleActions(e) {
            const target = e.target.closest('button');
            if (!target) return;

            const row = target.closest('tr');
            if (!row) return;

            const id = row.dataset.id;
            const name = row.dataset.name;

            if (target.classList.contains('delete-client-btn')) {
                if (confirm(`هل أنت متأكد من حذف العميل "${name}"؟`)) {
                    if (await api.delete(`clients/${id}`)) loadDashboardData();
                }
            } else if (target.classList.contains('delete-project-btn')) {
                if (confirm(`هل أنت متأكد من حذف المشروع "${name}"؟`)) {
                    if (await api.delete(`projects/${id}`)) loadDashboardData();
                }
            } else if (target.classList.contains('delete-employee-btn')) {
                 if (confirm(`هل أنت متأكد من حذف الموظف "${name}"؟`)) {
                    if (await api.delete(`employees/${id}`)) loadDashboardData();
                }
            } else if (target.classList.contains('register-face-btn')) {
                handleRegisterFaceClick(name);
            }
        }
        
        // --- Face Registration (Admin) ---
        function stopVideo() {
            if (currentStream) {
                currentStream.getTracks().forEach(track => track.stop());
                currentStream = null;
            }
            if (faceDetectionInterval) {
                clearInterval(faceDetectionInterval);
                faceDetectionInterval = null;
            }
        }

        async function handleRegisterFaceClick(employeeName) {
            if (!faceApiReady) {
                return showAlert('نماذج التعرف على الوجه لم تحمل بعد، الرجاء الانتظار.');
            }
            const faceModal = document.getElementById('face-modal');
            const actionBtn = document.getElementById('action-btn');
            const cancelBtn = document.getElementById('cancel-btn');
            const statusMessage = document.getElementById('status-message');
            const video = document.getElementById('video');

            faceModal.classList.remove('hidden');
            faceModal.classList.add('flex');

            try {
                currentStream = await navigator.mediaDevices.getUserMedia({ video: {} });
                video.srcObject = currentStream;
            } catch(err) {
                showAlert('لا يمكن الوصول للكاميرا.');
                return;
            }

            let descriptor;
            faceDetectionInterval = setInterval(async () => {
                const detection = await faceapi.detectSingleFace(video, new faceapi.TinyFaceDetectorOptions()).withFaceLandmarks().withFaceDescriptor();
                if (detection) {
                    statusMessage.textContent = "تم اكتشاف الوجه. جاهز للتسجيل.";
                    actionBtn.disabled = false;
                    descriptor = detection.descriptor;
                } else {
                    statusMessage.textContent = "الرجاء توجيه وجه واحد للكاميرا.";
                    actionBtn.disabled = true;
                }
            }, 500);

            actionBtn.onclick = async () => {
                if (descriptor) {
                    const result = await api.post(`employees/${employeeName}/face`, { descriptor: Array.from(descriptor) });
                    if (result) {
                        showAlert('تم تسجيل بصمة الوجه بنجاح.', 2000);
                        loadDashboardData();
                    }
                    stopVideo();
                    faceModal.classList.add('hidden');
                }
            };
            cancelBtn.onclick = () => {
                stopVideo();
                faceModal.classList.add('hidden');
            };
        }
        
        // --- Reports ---
        async function generateReport() {
            const employeeName = document.getElementById('report-employee-select').value;
            const reportType = document.getElementById('report-type-select').value;
            if (!employeeName) return showAlert("الرجاء اختيار الموظف أولاً.");

            let startDate, endDate;
            if (reportType === 'monthly') {
                const monthValue = document.getElementById('month-picker').value;
                if (!monthValue) return showAlert("الرجاء اختيار الشهر.");
                const [year, month] = monthValue.split('-');
                startDate = `${year}-${month}-01`;
                const lastDay = new Date(year, month, 0).getDate();
                endDate = `${year}-${month}-${lastDay}`;
            } else { // yearly
                const year = document.getElementById('year-picker-input').value;
                if (!year) return showAlert("الرجاء اختيار السنة.");
                startDate = `${year}-01-01`;
                endDate = `${year}-12-31`;
            }
            
            const records = await api.get(`timesheets?employeeName=${employeeName}&startDate=${startDate}&endDate=${endDate}`);
            displayReport(records, reportType);
        }

        function displayReport(records, reportType) {
            const container = document.getElementById('report-results-container');
            container.innerHTML = '';
            
            if (records.length === 0) {
                container.innerHTML = '<p class="text-center text-gray-500 my-8">لا توجد سجلات تطابق معايير البحث.</p>';
                return;
            }
            
            if (reportType === 'monthly') {
                records.forEach(rec => {
                    const dayCard = document.createElement('div');
                    dayCard.className = 'bg-gray-50 p-4 rounded-lg border mb-4';
                    
                    let entriesHTML = '<p class="text-center text-gray-500">لا توجد حركات مسجلة لهذا اليوم.</p>';
                    if (rec.entries && rec.entries.length > 0) {
                        entriesHTML = rec.entries.map(entry => `
                            <div class="flex items-center justify-between p-3 border-b last:border-b-0">
                                <div>
                                    <p class="font-bold text-lg">${entry.type === 'check-in' ? 'دخول' : 'خروج'} - ${entry.time}</p>
                                    <p class="text-xs text-gray-500">GPS: ${entry.location.lat.toFixed(4)}, ${entry.location.lon.toFixed(4)}</p>
                                    <p class="text-xs text-gray-500">الموقع: جاري الجلب...</p> 
                                </div>
                                <div class="w-24 h-24 border rounded-md overflow-hidden">
                                    <iframe src="https://maps.google.com/maps?q=${entry.location.lat},${entry.location.lon}&hl=es;z=14&amp;output=embed" style="width:100%; height:100%; border:0;" allowfullscreen="" loading="lazy"></iframe>
                                </div>
                            </div>
                        `).join('');
                    }

                    dayCard.innerHTML = `
                        <div class="flex justify-between items-center mb-2 pb-2 border-b">
                            <h3 class="font-bold text-lg">${rec.date}</h3>
                            <div class="text-left">
                                <p class="text-sm">المشروع: <span class="font-semibold">${rec.project || '-'}</span></p>
                                <p class="text-sm">إجمالي الساعات: <span class="font-semibold">${(rec.totalHours || 0).toFixed(2)}</span></p>
                            </div>
                        </div>
                        <div class="space-y-2">${entriesHTML}</div>
                    `;
                    container.appendChild(dayCard);
                });
            } else { // yearly report
                const monthlyTotals = {};
                records.forEach(rec => {
                    const month = rec.date.substring(0, 7); // YYYY-MM
                    if (!monthlyTotals[month]) {
                        monthlyTotals[month] = 0;
                    }
                    monthlyTotals[month] += rec.totalHours || 0;
                });

                const table = document.createElement('table');
                table.className = 'w-full text-sm border-collapse';
                table.innerHTML = `
                    <thead class="bg-gray-100"><tr><th class="p-2 border">الشهر</th><th class="p-2 border">إجمالي الساعات</th></tr></thead>
                    <tbody>
                        ${Object.keys(monthlyTotals).sort().map(month => `
                            <tr>
                                <td class="p-2 border">${month}</td>
                                <td class="p-2 border">${monthlyTotals[month].toFixed(2)}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                `;
                container.appendChild(table);
            }
        }

        // --- Initial Load ---
        async function startup() {
            document.getElementById('loading-overlay').style.display = 'none';
            
            await checkServerStatus();
            setInterval(checkServerStatus, 15000);
            await loadDashboardData();
            
            // Event Listeners
            document.getElementById('add-employee-btn').addEventListener('click', addEmployee);
            document.getElementById('add-client-btn').addEventListener('click', addClient);
            document.getElementById('add-project-btn').addEventListener('click', addProject);
            document.getElementById('employees-table-body').addEventListener('click', handleActions);
            document.getElementById('clients-table-body').addEventListener('click', handleActions);
            document.getElementById('projects-table-body').addEventListener('click', handleActions);
            document.getElementById('generate-report-btn').addEventListener('click', generateReport);
            document.getElementById('report-type-select').addEventListener('change', (e) => {
                const isMonthly = e.target.value === 'monthly';
                document.getElementById('month-year-picker').classList.toggle('hidden', !isMonthly);
                document.getElementById('year-picker').classList.toggle('hidden', isMonthly);
            });

            handleNavigation();

            // Load face models asynchronously
            (async () => {
                try {
                    const MODEL_URL = 'https://justadudewhohacks.github.io/face-api.js/models';
                    await Promise.all([
                        faceapi.nets.tinyFaceDetector.loadFromUri(MODEL_URL),
                        faceapi.nets.faceLandmark68Net.loadFromUri(MODEL_URL),
                        faceapi.nets.faceRecognitionNet.loadFromUri(MODEL_URL)
                    ]);
                    faceApiReady = true;
                    console.log("Face API models loaded successfully.");
                } catch (error) {
                    console.error("Error loading face models:", error);
                    showAlert("فشل تحميل نماذج التعرف على الوجه.");
                }
            })();
        }

        document.addEventListener('DOMContentLoaded', startup);
    </script>

</body>
</html>
