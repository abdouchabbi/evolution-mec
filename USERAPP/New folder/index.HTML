<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>تطبيق الموظف (React)</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React & ReactDOM -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <!-- Babel to transpile JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- External Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap');
        body { font-family: 'Cairo', sans-serif; }
        .loader {
            border: 4px solid #f3f3f3; border-radius: 50%;
            border-top: 4px solid #4f46e5; width: 40px; height: 40px;
            animation: spin 2s linear infinite; margin: 20px auto;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .pin-input {
            width: 3rem; height: 3rem; text-align: center; font-size: 1.5rem;
            border: 2px solid #d1d5db; border-radius: 0.5rem;
            margin: 0 0.25rem;
        }
    </style>
</head>
<body class="bg-gray-100">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        const API_URL = 'https://evolution-mec2.onrender.com/api';

        // --- API Communication Layer ---
        const api = {
            async request(endpoint, method = 'GET', body = null, showAlert) {
                try {
                    const response = await fetch(`${API_URL}/${endpoint}`, {
                        method,
                        headers: { 'Content-Type': 'application/json' },
                        body: body ? JSON.stringify(body) : null,
                    });
                    const data = await response.json();
                    if (!response.ok) {
                        throw new Error(data.message || `خطأ في الخادم: ${response.statusText}`);
                    }
                    return data;
                } catch (error) {
                    console.error(`${method} ${endpoint} failed:`, error);
                    if (showAlert) {
                        const message = error.message.includes('Failed to fetch') 
                            ? 'فشل الاتصال بالخادم. الرجاء التأكد من أن الخادم يعمل.'
                            : `حدث خطأ: ${error.message}`;
                        showAlert(message);
                    }
                    throw error;
                }
            },
            get(endpoint, showAlert) { return this.request(endpoint, 'GET', null, showAlert); },
            post(endpoint, body, showAlert) { return this.request(endpoint, 'POST', body, showAlert); }
        };

        // --- Helper Components ---
        const Loader = ({ message }) => (
            <div className="fixed inset-0 bg-black bg-opacity-75 z-[100] flex flex-col items-center justify-center">
                <div className="loader"></div>
                <p className="text-white text-lg mt-4">{message}</p>
            </div>
        );

        const AlertModal = ({ message, isSuccess, onClose }) => (
            <div className="modal fixed inset-0 bg-gray-800 bg-opacity-50 flex items-center justify-center z-[60] p-4">
                <div className="modal-content bg-white p-6 sm:p-8 rounded-lg shadow-xl w-full max-w-md">
                    <p className={isSuccess ? 'text-green-600' : 'text-red-600'}>{message}</p>
                    <div className="mt-4 flex justify-end">
                        <button onClick={onClose} className="bg-blue-600 text-white px-4 py-2 rounded-md">موافق</button>
                    </div>
                </div>
            </div>
        );
        
        // --- View Components ---
        const FaceRecognitionView = ({ setRecognizedEmployee, showAlert }) => {
            const videoRef = useRef();
            const [status, setStatus] = useState('جاري البحث عن وجه...');
            let recognitionInterval = null;

            useEffect(() => {
                startVideo();
                return () => {
                    if (recognitionInterval) clearInterval(recognitionInterval);
                    if (videoRef.current && videoRef.current.srcObject) {
                        videoRef.current.srcObject.getTracks().forEach(track => track.stop());
                    }
                };
            }, []);

            const startVideo = async () => {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ video: {} });
                    videoRef.current.srcObject = stream;
                    
                    const employeesWithFaces = await api.get('employees/face-login-data', showAlert);
                    if (employeesWithFaces.length === 0) {
                        setStatus("لا يوجد موظفون مسجلون بالوجه.");
                        return;
                    }
                    
                    const labeledFaceDescriptors = employeesWithFaces.map(emp =>
                        new faceapi.LabeledFaceDescriptors(emp.name, [new Float32Array(emp.faceDescriptor)])
                    );
                    const faceMatcher = new faceapi.FaceMatcher(labeledFaceDescriptors, 0.5);
                    
                    recognitionInterval = setInterval(async () => {
                        if (videoRef.current && !videoRef.current.paused) {
                            const detection = await faceapi.detectSingleFace(videoRef.current, new faceapi.TinyFaceDetectorOptions()).withFaceLandmarks().withFaceDescriptor();
                            if (detection) {
                                const bestMatch = faceMatcher.findBestMatch(detection.descriptor);
                                if (bestMatch.label !== 'unknown') {
                                    const employee = employeesWithFaces.find(e => e.name === bestMatch.label);
                                    setRecognizedEmployee(employee);
                                } else {
                                    setStatus("لم يتم التعرف عليك. حاول مرة أخرى.");
                                }
                            } else {
                                setStatus("جاري البحث عن وجه...");
                            }
                        }
                    }, 2000);

                } catch (err) {
                    // Errors from api.get are already handled by the api layer
                }
            };

            return (
                <div className="flex items-center justify-center min-h-screen bg-gray-200">
                    <div className="w-full max-w-md p-8 space-y-6 bg-white rounded-lg shadow-md text-center">
                        <h2 className="text-2xl font-bold text-gray-700">الرجاء النظر إلى الكاميرا</h2>
                        <div className="bg-gray-200 w-full aspect-square rounded-md my-4 relative">
                            <video ref={videoRef} className="w-full h-full rounded-md" autoPlay muted playsInline></video>
                        </div>
                        <p className="text-lg font-semibold text-gray-600 h-8">{status}</p>
                    </div>
                </div>
            );
        };

        const PinView = ({ recognizedEmployee, setLoggedInEmployee, showAlert }) => {
            const [pin, setPin] = useState(Array(4).fill(""));
            const inputRefs = useRef([]);

            const handleInputChange = (e, index) => {
                const newPin = [...pin];
                newPin[index] = e.target.value;
                setPin(newPin);
                if (e.target.value && index < 3) inputRefs.current[index + 1].focus();
            };

            const handleKeyDown = (e, index) => {
                if (e.key === "Backspace" && !pin[index] && index > 0) inputRefs.current[index - 1].focus();
            };
            
            const handleSubmit = async (e) => {
                e.preventDefault();
                const pinCode = pin.join('');
                if (pinCode.length !== 4) return showAlert("الرجاء إدخال 4 أرقام.");
                try {
                    const employeeData = await api.post('employees/verify-pin', { employeeId: recognizedEmployee._id, pin: pinCode }, showAlert);
                    setLoggedInEmployee(employeeData);
                } catch (error) {
                    setPin(Array(4).fill(""));
                    inputRefs.current[0].focus();
                }
            };

            return (
                 <div className="flex items-center justify-center min-h-screen bg-gray-200">
                    <div className="w-full max-w-md p-8 space-y-6 bg-white rounded-lg shadow-md text-center">
                        <h2 className="text-2xl font-bold text-gray-700">أهلاً بك، {recognizedEmployee.name}!</h2>
                        <p className="text-gray-600">الرجاء إدخال رمز PIN الخاص بك</p>
                        <form onSubmit={handleSubmit}>
                            <div className="flex justify-center my-4">
                                {pin.map((digit, index) => (
                                    <input
                                        key={index}
                                        ref={el => inputRefs.current[index] = el}
                                        type="password"
                                        maxLength="1"
                                        value={digit}
                                        onChange={e => handleInputChange(e, index)}
                                        onKeyDown={e => handleKeyDown(e, index)}
                                        className="pin-input"
                                    />
                                ))}
                            </div>
                            <button type="submit" className="w-full px-4 py-2 text-lg font-bold text-white bg-indigo-600 rounded-md hover:bg-indigo-700">تحقق</button>
                        </form>
                    </div>
                </div>
            );
        };

        const MainAppView = ({ loggedInEmployee, onLogout, showAlert }) => {
            const [isVerificationModalOpen, setVerificationModalOpen] = useState(false);
            const [isReportModalOpen, setReportModalOpen] = useState(false);
            
            return (
                <div className="container mx-auto p-4 max-w-4xl">
                    <header className="flex justify-between items-center mb-6">
                        <div>
                            <h1 className="text-2xl font-bold text-gray-800">مرحبا، {loggedInEmployee.name}!</h1>
                            <p className="text-gray-500">جاهز لبدء يومك؟</p>
                        </div>
                        <button onClick={onLogout} className="text-sm text-red-600 hover:underline">تسجيل الخروج</button>
                    </header>

                    <main className="bg-white p-6 rounded-lg shadow-md text-center">
                        <h2 className="text-xl font-semibold mb-2">تسجيل الحضور والانصراف</h2>
                        <p className="text-gray-500 mb-6">{new Date().toLocaleDateString('ar-EG', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}</p>
                        <button onClick={() => setVerificationModalOpen(true)} className="bg-green-500 text-white font-bold py-4 px-8 rounded-full shadow-lg hover:bg-green-600 transition text-lg">تسجيل الآن</button>
                    </main>

                    <footer className="mt-8">
                        <div className="bg-white p-6 rounded-lg shadow-md">
                           <h2 className="text-xl font-semibold mb-4">سجلاتي الشهرية</h2>
                           <button onClick={() => setReportModalOpen(true)} className="bg-blue-600 text-white px-4 py-2 rounded-lg">عرض السجلات</button>
                        </div>
                    </footer>

                    {isVerificationModalOpen && <VerificationModal loggedInEmployee={loggedInEmployee} onClose={() => setVerificationModalOpen(false)} showAlert={showAlert} />}
                    {isReportModalOpen && <ReportModal loggedInEmployee={loggedInEmployee} onClose={() => setReportModalOpen(false)} showAlert={showAlert} />}
                </div>
            );
        };

        const VerificationModal = ({ loggedInEmployee, onClose, showAlert }) => {
             const videoRef = useRef();
             const [status, setStatus] = useState('الرجاء توجيه الوجه للكاميرا...');
             const [isVerified, setVerified] = useState(false);
             const [isSubmitting, setIsSubmitting] = useState(false);
             let verificationInterval = null;

             useEffect(() => {
                startVerificationVideo();
                return () => {
                    if (verificationInterval) clearInterval(verificationInterval);
                    if (videoRef.current && videoRef.current.srcObject) {
                        videoRef.current.srcObject.getTracks().forEach(track => track.stop());
                    }
                };
            }, []);

            const startVerificationVideo = async () => {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ video: {} });
                    videoRef.current.srcObject = stream;

                    const faceMatcher = new faceapi.FaceMatcher([new Float32Array(loggedInEmployee.faceDescriptor)], 0.5);
                    
                    verificationInterval = setInterval(async () => {
                         if (videoRef.current && !videoRef.current.paused) {
                            const detection = await faceapi.detectSingleFace(videoRef.current, new faceapi.TinyFaceDetectorOptions()).withFaceLandmarks().withFaceDescriptor();
                            if (detection) {
                                const bestMatch = faceMatcher.findBestMatch(detection.descriptor);
                                if (bestMatch.label !== 'unknown') {
                                    setStatus("تم التعرف عليك. جاهز للتأكيد.");
                                    setVerified(true);
                                } else {
                                    setStatus("الوجه غير مطابق.");
                                    setVerified(false);
                                }
                            } else {
                                setStatus("لم يتم اكتشاف وجه.");
                                setVerified(false);
                            }
                        }
                    }, 1000);
                } catch (err) {
                     showAlert("لا يمكن الوصول إلى الكاميرا. يرجى منح الإذن اللازم.");
                     onClose();
                }
            };
            
            const handleConfirm = async () => {
                setIsSubmitting(true);
                setStatus("جاري تحديد الموقع...");
                
                const detection = await faceapi.detectSingleFace(videoRef.current, new faceapi.TinyFaceDetectorOptions()).withFaceLandmarks().withFaceDescriptor();
                if (!detection) {
                    setIsSubmitting(false);
                    return showAlert("فشل التقاط صورة الوجه.");
                }
                const faceDescriptor = Array.from(detection.descriptor);

                navigator.geolocation.getCurrentPosition(async (position) => {
                    const location = { lat: position.coords.latitude, lon: position.coords.longitude };
                    const now = new Date();
                    const date = now.toISOString().split('T')[0];
                    const time = `${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}`;
                    
                    try {
                         await api.post('timesheets/entry', { 
                            employeeName: loggedInEmployee.name, 
                            date, time, location, faceDescriptor
                        }, showAlert);
                        showAlert("تم التسجيل بنجاح!", true);
                    } catch(error) { /* error is handled by the api layer */ }
                    finally {
                        onClose();
                    }

                }, () => {
                    showAlert("لا يمكن الحصول على الموقع. يرجى تفعيل خدمات الموقع.");
                    setIsSubmitting(false);
                    onClose();
                }, { enableHighAccuracy: true });
            };

             return (
                 <div className="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                    <div className="modal-content bg-white rounded-lg shadow-xl w-full max-w-sm p-6 text-center">
                        <h3 className="text-lg font-bold mb-4">التحقق من الهوية للتسجيل</h3>
                        <div className="bg-gray-200 w-full aspect-square rounded-md mb-4">
                            <video ref={videoRef} className="w-full h-full rounded-md" autoPlay muted playsInline></video>
                        </div>
                        <p className="mb-4 h-6">{status}</p>
                        <div className="flex gap-4">
                            <button onClick={onClose} disabled={isSubmitting} className="w-full bg-gray-500 text-white py-2 rounded-lg disabled:bg-gray-300">إلغاء</button>
                            <button onClick={handleConfirm} disabled={!isVerified || isSubmitting} className="w-full bg-green-500 text-white py-2 rounded-lg disabled:bg-gray-400">
                                {isSubmitting ? 'جاري التسجيل...' : 'تأكيد'}
                            </button>
                        </div>
                    </div>
                </div>
             );
        };
        
        const ReportModal = ({ loggedInEmployee, onClose, showAlert }) => {
            const [month, setMonth] = useState(new Date().getMonth());
            const [year, setYear] = useState(new Date().getFullYear());
            const [records, setRecords] = useState([]);
            const [loading, setLoading] = useState(false);

            useEffect(() => {
                handleViewReport(); // Load current month's report on open
            }, []);

            const handleViewReport = async () => {
                setLoading(true);
                try {
                    const startDate = new Date(year, month, 1).toISOString().split('T')[0];
                    const endDate = new Date(year, month + 1, 0).toISOString().split('T')[0];
                    const data = await api.get(`timesheets?employeeName=${loggedInEmployee.name}&startDate=${startDate}&endDate=${endDate}`, showAlert);
                    setRecords(data);
                } catch (error) {
                    // Error is handled by api layer
                } finally {
                    setLoading(false);
                }
            };
            
            const months = ["يناير", "فبراير", "مارس", "أبريل", "مايو", "يونيو", "يوليو", "أغسطس", "سبتمبر", "أكتوبر", "نوفمبر", "ديسمبر"];
            const years = Array.from({length: 5}, (_, i) => new Date().getFullYear() - i);
            const daysOfWeek = ["الأحد", "الإثنين", "الثلاثاء", "الأربعاء", "الخميس", "الجمعة", "السبت"];

            return (
                 <div className="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                    <div className="modal-content bg-white rounded-lg shadow-xl w-full max-w-4xl h-[90vh] p-6 flex flex-col">
                         <h2 className="text-xl font-semibold mb-4">سجلاتي الشهرية</h2>
                         <div className="flex items-end gap-4 mb-4">
                            <div className="flex-grow">
                                <label htmlFor="report-month-select" className="block text-sm font-medium">الشهر:</label>
                                <select id="report-month-select" value={month} onChange={e => setMonth(parseInt(e.target.value))} className="mt-1 block w-full p-2 border border-gray-300 rounded-md">
                                    {months.map((m, i) => <option key={i} value={i}>{m}</option>)}
                                </select>
                            </div>
                            <div className="flex-grow">
                                <label htmlFor="report-year-select" className="block text-sm font-medium">السنة:</label>
                                <select id="report-year-select" value={year} onChange={e => setYear(parseInt(e.target.value))} className="mt-1 block w-full p-2 border border-gray-300 rounded-md">
                                    {years.map(y => <option key={y} value={y}>{y}</option>)}
                                </select>
                            </div>
                            <button onClick={handleViewReport} className="bg-blue-600 text-white px-4 py-2 rounded-lg">عرض</button>
                         </div>
                         <div className="flex-grow overflow-auto border-t pt-4">
                            {loading ? <Loader message="جاري جلب السجلات..."/> : 
                                records.length > 0 ? (
                                    <table className="w-full text-sm text-center">
                                        <thead className="bg-gray-100 sticky top-0">
                                            <tr>
                                                <th className="p-2 border">اليوم</th>
                                                <th className="p-2 border">التاريخ</th>
                                                <th className="p-2 border">الدخول</th>
                                                <th className="p-2 border">الخروج</th>
                                                <th className="p-2 border">إجمالي الساعات</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {records.map(record => {
                                                const recordDate = new Date(record.date);
                                                const checkIns = record.entries.filter(e => e.type === 'check-in');
                                                const checkOuts = record.entries.filter(e => e.type === 'check-out');

                                                return (
                                                    <tr key={record._id} className="border-b">
                                                        <td className="p-2 border">{daysOfWeek[recordDate.getUTCDay()]}</td>
                                                        <td className="p-2 border">{recordDate.toLocaleDateString('ar-EG')}</td>
                                                        <td className="p-2 border">
                                                            {checkIns.map((entry, i) => <div key={i}>{entry.time} <a href={`https://www.google.com/maps?q=${entry.location.lat},${entry.location.lon}`} target="_blank" className="text-blue-500">📍</a></div>)}
                                                        </td>
                                                        <td className="p-2 border">
                                                            {checkOuts.map((entry, i) => <div key={i}>{entry.time} <a href={`https://www.google.com/maps?q=${entry.location.lat},${entry.location.lon}`} target="_blank" className="text-blue-500">📍</a></div>)}
                                                        </td>
                                                        <td className="p-2 border font-bold">{record.totalHours.toFixed(2)}</td>
                                                    </tr>
                                                );
                                            })}
                                        </tbody>
                                    </table>
                                ) : (
                                    <p className="text-center text-gray-500">لا توجد سجلات لهذا الشهر.</p>
                                )
                            }
                         </div>
                         <div className="mt-auto flex justify-end pt-4">
                            <button onClick={onClose} className="bg-gray-500 text-white px-4 py-2 rounded-lg">إغلاق</button>
                         </div>
                    </div>
                 </div>
            );
        }

        // --- Main App Controller ---
        function App() {
            const [view, setView] = useState('loading'); // loading, face, pin, main
            const [recognizedEmployee, setRecognizedEmployee] = useState(null);
            const [loggedInEmployee, setLoggedInEmployee] = useState(null);
            const [alert, setAlert] = useState({ show: false, message: '', isSuccess: false });
            
            useEffect(() => {
                async function loadModels() {
                     try {
                        const MODEL_URL = 'https://justadudewhohacks.github.io/face-api.js/models';
                        await Promise.all([
                            faceapi.nets.tinyFaceDetector.loadFromUri(MODEL_URL),
                            faceapi.nets.faceLandmark68Net.loadFromUri(MODEL_URL),
                            faceapi.nets.faceRecognitionNet.loadFromUri(MODEL_URL)
                        ]);
                        setView('face');
                    } catch (error) {
                        setAlert({ show: true, message: 'فشل تحميل نماذج التعرف على الوجه. الرجاء تحديث الصفحة.' });
                    }
                }
                loadModels();
            }, []);

            useEffect(() => {
                if (recognizedEmployee) setView('pin');
            }, [recognizedEmployee]);

            useEffect(() => {
                const storedEmployee = localStorage.getItem('loggedInEmployee');
                if(storedEmployee) {
                    setLoggedInEmployee(JSON.parse(storedEmployee));
                }
            }, []);

            useEffect(() => {
                if (loggedInEmployee) {
                    localStorage.setItem('loggedInEmployee', JSON.stringify(loggedInEmployee));
                    setView('main');
                } else {
                     localStorage.removeItem('loggedInEmployee');
                }
            }, [loggedInEmployee]);

            const showAlertWithState = (message, isSuccess = false) => {
                setAlert({ show: true, message, isSuccess });
            };

            const handleLogout = () => {
                setLoggedInEmployee(null);
                setRecognizedEmployee(null);
                setView('face');
            };

            const renderView = () => {
                switch(view) {
                    case 'loading':
                        return <Loader message="جاري تحميل النظام..." />;
                    case 'face':
                        return <FaceRecognitionView setRecognizedEmployee={setRecognizedEmployee} showAlert={showAlertWithState} />;
                    case 'pin':
                        return <PinView recognizedEmployee={recognizedEmployee} setLoggedInEmployee={setLoggedInEmployee} showAlert={showAlertWithState} />;
                    case 'main':
                        return <MainAppView loggedInEmployee={loggedInEmployee} onLogout={handleLogout} showAlert={showAlertWithState} />;
                    default:
                        return <Loader message="جاري تحميل النظام..." />;
                }
            };
            
            return (
                <div>
                    {alert.show && <AlertModal message={alert.message} isSuccess={alert.isSuccess} onClose={() => setAlert({ show: false })} />}
                    {renderView()}
                </div>
            );
        }

        ReactDOM.createRoot(document.getElementById("root")).render(<App />);
    </script>
</body>
</html>

